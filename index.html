<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
        }
        .item {
            display: flex;
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
        }
        .item img {
            max-width: 100px;
            margin-right: 20px;
        }
        .item-details {
            flex: 1;
        }
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin: 20px 0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ccc;
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <h1>Item Viewer</h1>

        <!-- Filter Section -->
        <div>
            <label for="categoryFilter">Filter by Category:</label>
            <select id="categoryFilter">
                <option value="">All Categories</option>
            </select>
        </div>

        <div>
            <label for="searchName">Search by Name:</label>
            <input type="text" id="searchName" placeholder="Enter name...">
        </div>

        <div>
            <label for="minPrice">Min Price:</label>
            <input type="number" id="minPrice" placeholder="Min Price">
            <label for="maxPrice">Max Price:</label>
            <input type="number" id="maxPrice" placeholder="Max Price">
            <button id="priceFilterButton">Filter by Price</button>
        </div>

        <!-- Items Section -->
        <div id="itemsContainer"></div>

        <!-- Pagination -->
        <div class="pagination">
            <button id="prevPage" disabled>Previous</button>
            <span id="pageInfo"></span>
            <button id="nextPage">Next</button>
        </div>
    </div>

    <script>
        const apiEndpoint = 'https://a0f4425e-2c11-4e87-ba3a-44ec6d51b3c7.mock.pstmn.io/fetchDataTiki'; // Replace with your actual API endpoint
        const itemsPerPage = 20;
        let items = [];
        let filteredItems = [];
        let currentPage = 1;

        const itemsContainer = document.getElementById('itemsContainer');
        const categoryFilter = document.getElementById('categoryFilter');
        const searchName = document.getElementById('searchName');
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const priceFilterButton = document.getElementById('priceFilterButton');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');

        async function fetchItems() {
            const loadingElement = document.getElementById('loading');
            itemsContainer.innerHTML = '';
            loadingElement.style.display = 'flex';

            try {
                const response = await fetch(apiEndpoint);
                items = await response.json();
                console.log('Fetched items:', items); // Debug: Check API data
                filteredItems = items;
                renderItems();
                populateCategories(); // Populate category filter dynamically
            } catch (error) {
                console.error('Error fetching items:', error);
                itemsContainer.innerHTML = '<p>Error loading items. Please try again later.</p>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        function populateCategories() {
            const fixedCategories = {
                nha_sach_tiki: "Nhà Sách Tiki",
                nha_cua_doi_song: "Nhà Cửa Đời Sống",
                dien_thoai_may_tinh_bang: "Điện Thoại Máy Tính Bảng",
                do_choi_me_be: "Đồ Chơi Mẹ Bé",
                thiet_bi_so_phu_kien_so: "Thiết Bị Số Phụ Kiện Số",
                dien_gia_dung: "Điện Gia Dụng",
                lam_dep_suc_khoe: "Làm Đẹp Sức Khỏe",
                oto_xe_may_xe_dap: "Ô Tô Xe Máy Xe Đạp",
                thoi_trang_nu: "Thời Trang Nữ",
                bach_hoa_online: "Bách Hóa Online",
                the_thao_da_ngoai: "Thể Thao Dã Ngoại",
                thoi_trang_nam: "Thời Trang Nam",
                cross_border: "Cross Border",
                laptop_may_vi_tinh_linh_kien: "Laptop Máy Vi Tính Linh Kiện",
                giay_dep_nam: "Giày Dép Nam",
                dien_tu_dien_lanh: "Điện Tử Điện Lạnh",
                giay_dep_nu: "Giày Dép Nữ",
                may_anh_may_quay_phim: "Máy Ảnh Máy Quay Phim",
                phu_kien_thoi_trang: "Phụ Kiện Thời Trang",
                ngon: "Ngon",
                dong_ho_trang_suc: "Đồng Hồ Trang Sức",
                balo_vali: "Balo Vali",
                voucher_dich_vu: "Voucher Dịch Vụ",
                tui_thoi_trang_nu: "Túi Thời Trang Nữ",
                tui_thoi_trang_nam: "Túi Thời Trang Nam",
                cham_soc_nha_cua: "Chăm Sóc Nhà Cửa",
            };

            // Lấy danh mục từ API
            const categoriesFromAPI = [...new Set(items.map(item => item.category))];

            // Duyệt qua danh mục cố định
            const allCategories = Object.keys(fixedCategories);

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category; // Giá trị gốc từ API
                option.textContent = fixedCategories[category] || category; // Tên hiển thị tiếng Việt
                categoryFilter.appendChild(option);
            });

            console.log('All categories displayed in filter:', allCategories.map(cat => ({
                value: cat,
                name: fixedCategories[cat] || cat
            })));
        }



        function renderItems() {
            itemsContainer.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentItems = filteredItems.slice(startIndex, endIndex);

            if (currentItems.length === 0) {
                itemsContainer.innerHTML = `<p>Không tìm thấy sản phẩm nào. Vui lòng thử danh mục khác hoặc điều chỉnh bộ lọc.</p>`;
                updatePagination();
                return;
            }

            currentItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('item');

                const color = getRatingColor(item.rating_average);
                itemElement.innerHTML = `
                    <img src="${item.image_url}" alt="${item.title}">
                    <div class="item-details">
                        <h3>${item.title}</h3>
                        <p>Price: ${item.price.toLocaleString()} VND</p>
                        <p>Original Price: ${item.original_price.toLocaleString()} VND</p>
                        <p>Sold: ${item.sold}</p>
                        <p>Reviews: ${item.review_count}</p>
                        <p style="color: ${color}; font-weight: bold;">
                            Average Rating: ${item.rating_average.toFixed(1)}
                        </p>
                        <a href="${item.product_link}" target="_blank">View Product</a>
                    </div>
                `;
                itemsContainer.appendChild(itemElement);
            });

            updatePagination();
        }

        function getRatingColor(rating) {
            if (rating >= 4.5) return '#28a745';
            if (rating >= 3.5) return '#85c226';
            if (rating >= 2.5) return '#ffc107';
            if (rating >= 1.5) return '#fd7e14';
            return '#dc3545';
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
        }

        categoryFilter.addEventListener('change', () => {
            const category = categoryFilter.value;
            console.log('Selected category:', category);
            filteredItems = category ? items.filter(item => item.category === category) : items;
            console.log('Filtered items for category:', filteredItems);
            currentPage = 1;
            renderItems();
        });

        searchName.addEventListener('input', () => {
            const nameQuery = searchName.value.toLowerCase();
            filteredItems = items.filter(item => item.title.toLowerCase().includes(nameQuery));
            currentPage = 1;
            renderItems();
        });

        priceFilterButton.addEventListener('click', () => {
            const min = parseFloat(minPrice.value) || 0;
            const max = parseFloat(maxPrice.value) || Infinity;
            console.log('Filter by price:', { min, max });
            filteredItems = items.filter(item => item.price >= min && item.price <= max);
            console.log('Filtered items by price:', filteredItems);
            currentPage = 1;
            renderItems();
        });

        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderItems();
            }
        });

        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderItems();
            }
        });

        fetchItems();
    </script>
</body>
</html>
